<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>时光计划 - 智能计划管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    // Tailwind 配置
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            dark: '#1F2937',
            light: '#F9FAFB'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .transition-height {
        transition: max-height 0.3s ease-in-out;
      }
      .bg-blur {
        backdrop-filter: blur(8px);
      }
      .task-complete {
        text-decoration: line-through;
        color: #9CA3AF;
      }
      .btn-disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        pointer-events: none;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 flex flex-col">
  <!-- 初始界面 - 选择加载或创建计划 -->
  <div id="initialScreen" class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-primary/90 to-primary">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-500 hover:shadow-primary/20">
      <div class="p-8">
        <div class="text-center mb-8">
          <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2">时光计划</h1>
          <p class="text-gray-500">高效管理您的日常计划与任务</p>
        </div>

        <div class="space-y-4">
          <button id="createPlanBtn" class="w-full py-4 px-6 bg-primary hover:bg-primary/90 text-white rounded-xl font-medium transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
            <i class="fa fa-plus-circle text-xl"></i>
            <span>创建新计划</span>
          </button>

          <div class="relative">
            <button id="loadPlanBtn" class="w-full py-4 px-6 bg-white border-2 border-primary text-primary hover:bg-primary/5 rounded-xl font-medium transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2">
              <i class="fa fa-folder-open text-xl"></i>
              <span>加载已有计划</span>
            </button>
            <input type="file" id="fileInput" accept=".yplan" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </div>
        </div>
      </div>

      <div class="bg-gray-50 p-4 text-center text-sm text-gray-500">
        <p>计划将保存为 <code class="bg-gray-200 px-1 rounded">.yplan</code> 格式文件</p>
      </div>
    </div>

    <div class="mt-8 text-white/80 text-center max-w-md">
      <p class="mb-2"><i class="fa fa-lightbulb-o mr-1"></i> 制定计划是成功的第一步</p>
      <p id="initialQuote" class="italic mt-1">—— 随机名言</p>
    </div>
  </div>

  <!-- 创建计划界面 -->
  <div id="createPlanScreen" class="hidden flex-1 flex flex-col bg-gray-50">
    <header class="bg-white shadow-sm sticky top-0 z-10">
      <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <button id="backToInitialBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
            <i class="fa fa-arrow-left text-gray-600"></i>
          </button>
          <h1 class="text-xl font-bold text-primary">创建新计划</h1>
        </div>
        <button id="savePlanBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-1 btn-disabled" disabled>
          <i class="fa fa-save"></i>
          <span>保存计划</span>
        </button>
      </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl flex-1">
      <form id="planForm" class="space-y-8">
        <!-- 基本信息 -->
        <section class="bg-white rounded-xl shadow-sm p-6 transition-all hover:shadow-md">
          <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-user-circle text-primary mr-2"></i>基本信息
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名 <span class="text-danger">*</span></label>
              <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="请输入您的姓名" required>
            </div>
            <div>
              <label for="planName" class="block text-sm font-medium text-gray-700 mb-1">计划名称 <span class="text-danger">*</span></label>
              <input type="text" id="planName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="例如：考研复习计划" required>
            </div>
          </div>
        </section>

        <!-- 时间设置 -->
        <section class="bg-white rounded-xl shadow-sm p-6 transition-all hover:shadow-md">
          <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-calendar text-primary mr-2"></i>时间设置
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">开始日期 <span class="text-danger">*</span></label>
              <input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" required>
            </div>
            <div>
              <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">结束日期 <span class="text-danger">*</span></label>
              <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" required>
            </div>
          </div>
        </section>

        <!-- 每日任务设置 -->
        <section class="bg-white rounded-xl shadow-sm p-6 transition-all hover:shadow-md">
          <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-tasks text-primary mr-2"></i>每日任务
          </h2>
          <p class="text-sm text-gray-500 mb-4">设置每日重复的任务，后续可以针对特定日期进行修改</p>

          <div id="dailyTasksContainer" class="space-y-4">
            <div class="task-item flex items-center gap-3">
              <input type="text" placeholder="输入任务内容..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
              <input type="time" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
              <button type="button" class="remove-task-btn p-2 text-gray-400 hover:text-danger transition-colors">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>

          <button type="button" id="addTaskBtn" class="mt-4 text-primary hover:text-primary/80 font-medium flex items-center gap-1 transition-colors">
            <i class="fa fa-plus-circle"></i>
            <span>添加任务</span>
          </button>
        </section>
      </form>
    </main>
  </div>

  <!-- 计划执行界面 -->
  <div id="planExecutionScreen" class="hidden flex-1 flex flex-col bg-gray-50">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
      <div class="container mx-auto px-4 py-3">
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
            <button id="backToCreateBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
              <i class="fa fa-arrow-left text-gray-600"></i>
            </button>
            <div>
              <h1 id="executionPlanName" class="text-lg font-bold text-primary"></h1>
              <p class="text-sm text-gray-500 flex items-center gap-1">
                <span id="executionUsername"></span>
                <span class="text-gray-300">|</span>
                <span id="currentDateDisplay"></span>
              </p>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="saveExecutionBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1.5 rounded-lg transition-colors text-sm flex items-center gap-1">
              <i class="fa fa-save"></i>
              <span>保存</span>
            </button>
            <button id="exportPlanBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1.5 rounded-lg transition-colors text-sm flex items-center gap-1">
              <i class="fa fa-download"></i>
              <span>导出</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- 进度条 -->
    <div class="bg-white border-t border-gray-100 py-3 sticky top-16 z-20">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center mb-1">
          <span class="text-sm font-medium text-gray-600">计划进度</span>
          <span id="progressText" class="text-sm font-medium text-primary"></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <main class="container mx-auto px-4 py-6 max-w-4xl flex-1">
      <!-- 日期导航 -->
      <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
        <div class="flex justify-between items-center">
          <button id="prevDayBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
            <i class="fa fa-chevron-left text-gray-600"></i>
          </button>

          <div class="flex-1 mx-4 text-center">
            <h2 id="currentDayHeader" class="text-lg font-semibold"></h2>
            <p class="text-sm text-gray-500" id="dayProgressText"></p>
          </div>

          <div class="flex gap-2">
            <button id="skipDayBtn" class="px-3 py-1.5 bg-warning/10 text-warning rounded-lg text-sm hover:bg-warning/20 transition-colors">
              <i class="fa fa-pause"></i>
              <span>休息</span>
            </button>
            <button id="nextDayBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
              <i class="fa fa-chevron-right text-gray-600"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- 每日任务列表 -->
      <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold flex items-center">
            <i class="fa fa-list-alt text-primary mr-2"></i>今日任务
          </h2>
          <button id="addDailyTaskBtn" class="text-primary hover:text-primary/80 text-sm font-medium flex items-center gap-1 transition-colors">
            <i class="fa fa-plus"></i>
            <span>添加任务</span>
          </button>
        </div>

        <div id="dailyTasksList" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
          <!-- 任务项将通过JS动态生成 -->
          <div class="text-center text-gray-500 py-8" id="noTasksMessage">
            <i class="fa fa-calendar-o text-4xl mb-2 opacity-30"></i>
            <p>暂无任务，点击"添加任务"开始创建</p>
          </div>
        </div>
      </div>

      <!-- 工具区 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 计时器 -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-clock-o text-primary mr-2"></i>专注计时器
          </h2>
          <div class="text-center">
            <div id="timerDisplay" class="text-4xl font-mono font-bold text-gray-800 mb-4">00:00:00</div>
            <div class="flex justify-center gap-3">
              <button id="startTimerBtn" class="bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fa fa-play mr-1"></i>开始
              </button>
              <button id="pauseTimerBtn" class="bg-warning hover:bg-warning/90 text-white px-4 py-2 rounded-lg transition-colors hidden">
                <i class="fa fa-pause mr-1"></i>暂停
              </button>
              <button id="resetTimerBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                <i class="fa fa-refresh mr-1"></i>重置
              </button>
            </div>
            <div class="mt-4 flex justify-center gap-2 flex-wrap">
              <button class="timer-preset px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors" data-time="25">25分钟</button>
              <button class="timer-preset px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors" data-time="45">45分钟</button>
              <button class="timer-preset px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors" data-time="60">60分钟</button>
              <button class="timer-preset px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors" data-time="90">90分钟</button>
            </div>
          </div>
        </div>

        <!-- 古诗词欣赏 -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-book text-primary mr-2"></i>古诗词欣赏
          </h2>
          <div class="text-center">
            <div id="poemContainer" class="mb-4 min-h-[100px] flex items-center justify-center">
              <p class="text-gray-700 italic" id="currentPoem">加载中...</p>
            </div>
            <p class="text-sm text-gray-500 mb-3" id="poemAuthor">—— 作者</p>
            <button id="refreshPoemBtn" class="text-primary hover:text-primary/80 text-sm font-medium flex items-center gap-1 transition-colors mx-auto">
              <i class="fa fa-refresh"></i>
              <span>换一首</span>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 通知提示框 -->
  <div id="notification" class="fixed bottom-4 right-4 bg-dark text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2 z-50">
    <i id="notificationIcon" class="fa fa-info-circle"></i>
    <span id="notificationText">通知内容</span>
  </div>

  <!-- 页脚版权信息 -->
  <footer class="bg-white border-t border-gray-200 py-4 text-center text-gray-500 text-sm">
    <div class="container mx-auto px-4">
      <p>© 2025 时光计划 版权所有 | 高效计划管理工具</p>
      <p class="mt-1">使用 Tailwind CSS 和 JavaScript 开发</p>
    </div>
  </footer>

  <script>
    // 确保DOM完全加载后再执行
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM完全加载，开始初始化应用');

      // 古诗词数据
      const poems = [
        {
          content: "盛年不重来，一日难再晨。及时当勉励，岁月不待人。",
          author: "陶渊明《杂诗》"
        },
        {
          content: "三更灯火五更鸡，正是男儿读书时。黑发不知勤学早，白首方悔读书迟。",
          author: "颜真卿《劝学诗》"
        },
        {
          content: "明日复明日，明日何其多。我生待明日，万事成蹉跎。",
          author: "钱福《明日歌》"
        },
        {
          content: "读书不觉已春深，一寸光阴一寸金。不是道人来引笑，周情孔思正追寻。",
          author: "王贞白《白鹿洞二首·其一》"
        },
        {
          content: "百川东到海，何时复西归？少壮不努力，老大徒伤悲。",
          author: "汉乐府《长歌行》"
        }
      ];

      // 随机名言
      const quotes = [
        "计划的制定比计划本身更为重要。—— 戴尔·卡耐基",
        "凡事预则立，不预则废。—— 《礼记·中庸》",
        "没有计划的目标是空想，没有目标的计划是徒劳。",
        "时间是一切财富中最宝贵的财富。—— 德奥弗拉斯多",
        "今天应做的事没有做，明天再早也是耽误了。—— 裴斯泰洛齐"
      ];

      // 全局变量
      let currentPlan = null;
      let currentDate = null;
      let timerInterval = null;
      let timerSeconds = 0;
      let isTimerRunning = false;

      // DOM 元素 - 确保元素已加载
      const initialScreen = document.getElementById('initialScreen');
      const createPlanScreen = document.getElementById('createPlanScreen');
      const planExecutionScreen = document.getElementById('planExecutionScreen');
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      const notificationIcon = document.getElementById('notificationIcon');
      const savePlanBtn = document.getElementById('savePlanBtn');

      // 验证关键元素是否存在
      if (!savePlanBtn) {
        console.error('保存按钮元素未找到！');
        alert('系统错误：未找到保存按钮，请刷新页面重试。');
        return;
      }

      // 初始化页面
      function init() {
        console.log('开始初始化应用');

        // 设置默认日期
        const today = new Date();
        const formattedToday = today.toISOString().split('T')[0];
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        if (startDateInput) startDateInput.value = formattedToday;

        // 设置默认结束日期为30天后
        const endDate = new Date();
        endDate.setDate(today.getDate() + 30);
        if (endDateInput) endDateInput.value = endDate.toISOString().split('T')[0];

        // 显示随机名言
        showRandomQuote();

        // 显示随机古诗词
        showRandomPoem();

        // 添加事件监听器
        addEventListeners();

        // 初始检查表单状态
        checkFormValidity();

        console.log('初始化完成');
      }

      // 检查表单有效性并更新保存按钮状态
      function checkFormValidity() {
        console.log('检查表单有效性');

        const usernameInput = document.getElementById('username');
        const planNameInput = document.getElementById('planName');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        // 检查元素是否存在
        if (!usernameInput || !planNameInput || !startDateInput || !endDateInput) {
          console.error('表单元素不完整');
          return false;
        }

        const username = usernameInput.value.trim();
        const planName = planNameInput.value.trim();
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const taskItems = document.querySelectorAll('#dailyTasksContainer .task-item');

        // 检查是否有至少一个有效的任务
        let hasValidTask = false;
        taskItems.forEach(item => {
          const taskText = item.querySelector('input[type="text"]')?.value.trim();
          if (taskText) {
            hasValidTask = true;
          }
        });

        // 检查所有必填项
        const isFormValid = username && planName && startDate && endDate && hasValidTask;

        console.log(`表单有效性: ${isFormValid}`);

        // 更新保存按钮状态
        if (isFormValid) {
          savePlanBtn.removeAttribute('disabled');
          savePlanBtn.classList.remove('btn-disabled');
        } else {
          savePlanBtn.setAttribute('disabled', 'disabled');
          savePlanBtn.classList.add('btn-disabled');
        }

        return isFormValid;
      }

      // 显示随机名言
      function showRandomQuote() {
        const randomIndex = Math.floor(Math.random() * quotes.length);
        const quoteElement = document.getElementById('initialQuote');
        if (quoteElement) {
          quoteElement.textContent = `—— ${quotes[randomIndex]}`;
        }
      }

      // 显示随机古诗词
      function showRandomPoem() {
        const randomIndex = Math.floor(Math.random() * poems.length);
        const poem = poems[randomIndex];
        const poemElement = document.getElementById('currentPoem');
        const authorElement = document.getElementById('poemAuthor');

        if (poemElement && authorElement) {
          poemElement.textContent = poem.content;
          authorElement.textContent = `—— ${poem.author}`;
        }
      }

      // 添加事件监听器
      function addEventListeners() {
        console.log('添加事件监听器');

        // 为表单字段添加输入事件监听器，实时检查表单有效性
        document.getElementById('username')?.addEventListener('input', checkFormValidity);
        document.getElementById('planName')?.addEventListener('input', checkFormValidity);
        document.getElementById('startDate')?.addEventListener('change', checkFormValidity);
        document.getElementById('endDate')?.addEventListener('change', checkFormValidity);

        // 初始界面按钮
        document.getElementById('createPlanBtn')?.addEventListener('click', () => {
          console.log('点击创建新计划按钮');
          initialScreen.classList.add('hidden');
          createPlanScreen.classList.remove('hidden');
        });

        document.getElementById('loadPlanBtn')?.addEventListener('click', () => {
          console.log('点击加载已有计划按钮');
          document.getElementById('fileInput')?.click();
        });

        document.getElementById('fileInput')?.addEventListener('change', handleFileLoad);

        // 创建计划界面按钮
        document.getElementById('backToInitialBtn')?.addEventListener('click', () => {
          console.log('点击返回按钮');
          createPlanScreen.classList.add('hidden');
          initialScreen.classList.remove('hidden');
        });

        // 保存计划按钮 - 直接绑定事件，确保能触发
        savePlanBtn.addEventListener('click', function() {
          console.log('点击保存计划按钮');
          saveNewPlan();
        });

        document.getElementById('addTaskBtn')?.addEventListener('click', () => {
          console.log('点击添加任务按钮');
          addTaskItem();
          // 添加任务后检查表单有效性
          setTimeout(checkFormValidity, 0);
        });

        // 为初始任务项添加删除按钮事件
        document.querySelectorAll('.remove-task-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            console.log('点击删除任务按钮');
            this.closest('.task-item').remove();
            checkFormValidity();
          });
        });

        // 为任务输入框添加事件监听
        document.querySelectorAll('#dailyTasksContainer input[type="text"]').forEach(input => {
          input.addEventListener('input', checkFormValidity);
        });

        // 其他按钮事件监听器...
        document.getElementById('backToCreateBtn')?.addEventListener('click', () => {
          planExecutionScreen.classList.add('hidden');
          createPlanScreen.classList.remove('hidden');
        });

        document.getElementById('saveExecutionBtn')?.addEventListener('click', saveCurrentPlan);
        document.getElementById('exportPlanBtn')?.addEventListener('click', exportPlan);
        document.getElementById('prevDayBtn')?.addEventListener('click', () => navigateDay(-1));
        document.getElementById('nextDayBtn')?.addEventListener('click', () => navigateDay(1));
        document.getElementById('skipDayBtn')?.addEventListener('click', skipDay);
        document.getElementById('addDailyTaskBtn')?.addEventListener('click', addDailyTask);

        // 计时器按钮
        document.getElementById('startTimerBtn')?.addEventListener('click', startTimer);
        document.getElementById('pauseTimerBtn')?.addEventListener('click', pauseTimer);
        document.getElementById('resetTimerBtn')?.addEventListener('click', resetTimer);

        // 计时器预设
        document.querySelectorAll('.timer-preset').forEach(btn => {
          btn.addEventListener('click', function() {
            const minutes = parseInt(this.dataset.time);
            setTimer(minutes * 60);
          });
        });

        // 古诗词刷新
        document.getElementById('refreshPoemBtn')?.addEventListener('click', showRandomPoem);
      }

      // 添加任务项
      function addTaskItem() {
        const container = document.getElementById('dailyTasksContainer');
        if (!container) return;

        const taskItem = document.createElement('div');
        taskItem.className = 'task-item flex items-center gap-3';
        taskItem.innerHTML = `
          <input type="text" placeholder="输入任务内容..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
          <input type="time" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
          <button type="button" class="remove-task-btn p-2 text-gray-400 hover:text-danger transition-colors">
            <i class="fa fa-trash"></i>
          </button>
        `;

        container.appendChild(taskItem);

        // 为新添加的删除按钮添加事件
        taskItem.querySelector('.remove-task-btn').addEventListener('click', function() {
          taskItem.remove();
          checkFormValidity();
        });

        // 为新添加的任务输入框添加事件监听
        taskItem.querySelector('input[type="text"]').addEventListener('input', checkFormValidity);
      }

      // 深拷贝函数 - 确保对象完全独立
      function deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
      }

      // 保存新计划 - 确保此函数能被正确调用
      function saveNewPlan() {
        console.log('开始保存新计划');

        // 先检查表单有效性
        if (!checkFormValidity()) {
          showNotification('请完善计划信息后再保存', 'warning');
          return;
        }

        try {
          // 获取表单数据
          const username = document.getElementById('username').value.trim();
          const planName = document.getElementById('planName').value.trim();
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;

          // 验证日期逻辑
          if (new Date(startDate) > new Date(endDate)) {
            showNotification('开始日期不能晚于结束日期', 'warning');
            return;
          }

          // 获取任务列表
          const taskItems = document.querySelectorAll('#dailyTasksContainer .task-item');
          const baseTasks = [];

          taskItems.forEach(item => {
            const taskText = item.querySelector('input[type="text"]').value.trim();
            const taskTime = item.querySelector('input[type="time"]').value;

            if (taskText) {
              baseTasks.push({
                text: taskText,
                time: taskTime,
                completed: false
              });
            }
          });

          if (baseTasks.length === 0) {
            showNotification('请至少添加一个任务', 'warning');
            return;
          }

          // 创建计划对象
          currentPlan = {
            username,
            planName,
            startDate,
            endDate,
            baseTasks,
            days: {}
          };

          console.log('计划创建成功', currentPlan);

          // 初始化当前日期为开始日期
          currentDate = startDate;

          // 切换到计划执行界面
          switchToExecutionScreen();

          showNotification('计划创建成功', 'success');
        } catch (error) {
          console.error('保存计划时出错:', error);
          showNotification('保存计划失败: ' + error.message, 'danger');
        }
      }

      // 切换到计划执行界面
      function switchToExecutionScreen() {
        // 确保执行界面元素存在
        const executionPlanName = document.getElementById('executionPlanName');
        const executionUsername = document.getElementById('executionUsername');

        if (!executionPlanName || !executionUsername) {
          console.error('执行界面元素缺失');
          showNotification('切换界面失败，元素缺失', 'danger');
          return;
        }

        // 填充计划信息
        executionPlanName.textContent = currentPlan.planName;
        executionUsername.textContent = currentPlan.username;

        // 更新日期显示
        updateDateDisplay();

        // 加载当前日期的任务
        loadDayTasks();

        // 更新进度
        updateProgress();

        // 切换界面
        createPlanScreen.classList.add('hidden');
        planExecutionScreen.classList.remove('hidden');
      }

      // 更新日期显示
      function updateDateDisplay() {
        const dateObj = new Date(currentDate);
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const formattedDate = dateObj.toLocaleDateString('zh-CN', options);

        const currentDayHeader = document.getElementById('currentDayHeader');
        const currentDateDisplay = document.getElementById('currentDateDisplay');

        if (currentDayHeader) currentDayHeader.textContent = formattedDate;
        if (currentDateDisplay) currentDateDisplay.textContent = currentDate;
      }

      // 加载当天任务 - 修复核心：使用深拷贝确保每天任务独立
      function loadDayTasks() {
        const tasksList = document.getElementById('dailyTasksList');
        const noTasksMessage = document.getElementById('noTasksMessage');

        // 检查必要元素是否存在
        if (!tasksList) {
          console.error('任务列表容器不存在');
          return;
        }

        // 创建一个新的无任务消息元素（如果不存在）
        let noTasksEl = noTasksMessage;
        if (!noTasksEl) {
          noTasksEl = document.createElement('div');
          noTasksEl.id = 'noTasksMessage';
          noTasksEl.className = 'text-center text-gray-500 py-8';
          noTasksEl.innerHTML = `
            <i class="fa fa-calendar-o text-4xl mb-2 opacity-30"></i>
            <p>暂无任务，点击"添加任务"开始创建</p>
          `;
        }

        // 清空现有任务
        tasksList.innerHTML = '';

        // 关键修复：使用深拷贝创建独立的任务数组，避免引用共享
        if (!currentPlan.days[currentDate]) {
          // 首次访问该日期，基于基础任务创建独立副本
          currentPlan.days[currentDate] = {
            tasks: deepClone(currentPlan.baseTasks) // 使用深拷贝
          };
        }

        // 获取当天任务（已确保是独立副本）
        let dayTasks = currentPlan.days[currentDate].tasks;

        // 如果当天被标记为休息，则显示休息信息
        if (currentPlan.days[currentDate]?.skipped) {
          const skipMessage = document.createElement('div');
          skipMessage.className = 'text-center text-gray-500 py-8';
          skipMessage.innerHTML = `
            <i class="fa fa-coffee text-4xl mb-2 opacity-30"></i>
            <p>今天是休息日，好好放松一下吧！</p>
          `;
          tasksList.appendChild(skipMessage);
          document.getElementById('addDailyTaskBtn')?.classList.add('hidden');
          return;
        } else {
          document.getElementById('addDailyTaskBtn')?.classList.remove('hidden');
        }

        // 显示任务
        if (dayTasks.length === 0) {
          tasksList.appendChild(noTasksEl);
        } else {
          // 先添加无任务消息（如果需要会被移除）
          tasksList.appendChild(noTasksEl);

          dayTasks.forEach((task, index) => {
            addTaskToDOM(task, index);
          });
        }

        // 更新当天进度
        updateDayProgress();
      }

      // 添加任务到DOM
      function addTaskToDOM(task, index) {
        const tasksList = document.getElementById('dailyTasksList');
        const noTasksMessage = document.getElementById('noTasksMessage');

        if (!tasksList) return;

        const taskElement = document.createElement('div');
        taskElement.className = `flex items-center gap-3 p-3 border rounded-lg transition-all ${task.completed ? 'bg-gray-50' : 'bg-white hover:bg-gray-50'}`;
        taskElement.innerHTML = `
          <input type="checkbox" class="task-checkbox h-5 w-5 rounded text-primary focus:ring-primary/50" ${task.completed ? 'checked' : ''}>
          <div class="flex-1 min-w-0">
            <p class="text-gray-800 truncate ${task.completed ? 'task-complete' : ''}">${task.text}</p>
            ${task.time ? `<p class="text-xs text-gray-500 mt-0.5">${task.time}</p>` : ''}
          </div>
          <button type="button" class="edit-task-btn p-1.5 text-gray-400 hover:text-primary transition-colors">
            <i class="fa fa-pencil"></i>
          </button>
          <button type="button" class="delete-task-btn p-1.5 text-gray-400 hover:text-danger transition-colors">
            <i class="fa fa-trash"></i>
          </button>
        `;

        tasksList.appendChild(taskElement);

        // 如果存在"无任务"消息，则移除
        if (noTasksMessage && noTasksMessage.parentNode === tasksList) {
          tasksList.removeChild(noTasksMessage);
        }

        // 添加事件监听器
        taskElement.querySelector('.task-checkbox').addEventListener('change', function() {
          toggleTaskCompletion(index, this.checked);
        });

        taskElement.querySelector('.edit-task-btn').addEventListener('click', function() {
          editTask(index);
        });

        taskElement.querySelector('.delete-task-btn').addEventListener('click', function() {
          deleteTask(index);
        });
      }

      // 切换任务完成状态
      function toggleTaskCompletion(index, completed) {
        // 确保当前日期的任务对象存在
        if (!currentPlan.days[currentDate]) {
          currentPlan.days[currentDate] = { tasks: deepClone(currentPlan.baseTasks) };
        }

        // 更新任务状态
        currentPlan.days[currentDate].tasks[index].completed = completed;

        // 更新界面
        const checkboxes = document.querySelectorAll('#dailyTasksList .task-checkbox');
        if (checkboxes[index]) {
          const taskText = checkboxes[index].closest('div').querySelector('p');
          if (taskText) {
            if (completed) {
              taskText.classList.add('task-complete');
            } else {
              taskText.classList.remove('task-complete');
            }
          }
        }

        // 更新进度
        updateDayProgress();
        updateProgress();
      }

      // 编辑任务
      function editTask(index) {
        // 获取当前任务
        let tasks = currentPlan.days[currentDate]?.tasks || deepClone(currentPlan.baseTasks);
        const task = tasks[index];

        // 提示用户输入新内容
        const newText = prompt('编辑任务内容:', task.text);
        if (newText === null) return; // 用户取消

        // 确保当前日期的任务对象存在
        if (!currentPlan.days[currentDate]) {
          currentPlan.days[currentDate] = { tasks: deepClone(currentPlan.baseTasks) };
        }

        // 更新任务内容
        currentPlan.days[currentDate].tasks[index].text = newText.trim();

        // 重新加载任务列表
        loadDayTasks();
      }

      // 删除任务
      function deleteTask(index) {
        // 确认删除
        if (!confirm('确定要删除这个任务吗?')) return;

        // 确保当前日期的任务对象存在
        if (!currentPlan.days[currentDate]) {
          currentPlan.days[currentDate] = { tasks: deepClone(currentPlan.baseTasks) };
        }

        // 删除任务
        currentPlan.days[currentDate].tasks.splice(index, 1);

        // 重新加载任务列表
        loadDayTasks();

        // 更新进度
        updateProgress();
      }

      // 添加每日任务
      function addDailyTask() {
        // 提示用户输入任务内容
        const taskText = prompt('请输入任务内容:');
        if (!taskText || taskText.trim() === '') return;

        // 确保当前日期的任务对象存在
        if (!currentPlan.days[currentDate]) {
          currentPlan.days[currentDate] = { tasks: deepClone(currentPlan.baseTasks) };
        }

        // 如果当天被标记为休息，先取消休息状态
        if (currentPlan.days[currentDate].skipped) {
          delete currentPlan.days[currentDate].skipped;
        }

        // 添加新任务
        currentPlan.days[currentDate].tasks.push({
          text: taskText.trim(),
          time: '',
          completed: false
        });

        // 重新加载任务列表
        loadDayTasks();
      }

      // 导航到前一天或后一天
      function navigateDay(step) {
        const currentDateObj = new Date(currentDate);
        currentDateObj.setDate(currentDateObj.getDate() + step);

        const newDate = currentDateObj.toISOString().split('T')[0];

        // 检查是否在计划日期范围内
        if (newDate < currentPlan.startDate || newDate > currentPlan.endDate) {
          showNotification('已超出计划日期范围', 'warning');
          return;
        }

        // 保存当前日期的任务状态
        saveCurrentDayTasks();

        // 更新当前日期
        currentDate = newDate;

        // 更新显示
        updateDateDisplay();
        loadDayTasks();

        // 重置计时器
        resetTimer();
      }

      // 跳过当天（休息）
      function skipDay() {
        // 确保当前日期的任务对象存在
        if (!currentPlan.days[currentDate]) {
          currentPlan.days[currentDate] = { tasks: deepClone(currentPlan.baseTasks) };
        }

        // 切换休息状态
        currentPlan.days[currentDate].skipped = !currentPlan.days[currentDate].skipped;

        // 重新加载任务列表
        loadDayTasks();

        // 更新进度
        updateProgress();

        // 显示通知
        if (currentPlan.days[currentDate].skipped) {
          showNotification('已标记为休息日', 'info');
        } else {
          showNotification('已取消休息日', 'info');
        }
      }

      // 保存当前日期的任务
      function saveCurrentDayTasks() {
        // 不需要显式保存，因为我们直接在currentPlan对象上操作
      }

      // 保存当前计划
      function saveCurrentPlan() {
        // 计划是实时保存的，这里只是触发导出
        exportPlan();
      }

      // 导出计划
      function exportPlan() {
        if (!currentPlan) return;

        // 将计划转换为JSON字符串
        const planData = JSON.stringify(currentPlan, null, 2);
        const blob = new Blob([planData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        // 创建下载链接
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentPlan.planName.replace(/\s+/g, '_')}.yplan`;
        document.body.appendChild(a);
        a.click();

        // 清理
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);

        showNotification('计划已保存', 'success');
      }

      // 处理文件加载
      function handleFileLoad(event) {
        const file = event.target.files[0];
        if (!file) return;

        // 检查文件扩展名
        if (!file.name.endsWith('.yplan')) {
          showNotification('请选择.yplan格式的文件', 'warning');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const planData = JSON.parse(e.target.result);

            // 验证计划数据
            if (!planData.planName || !planData.startDate || !planData.endDate || !planData.baseTasks) {
              throw new Error('无效的计划文件');
            }

            // 加载计划
            currentPlan = planData;

            // 设置当前日期为今天或计划开始日期
            const today = new Date().toISOString().split('T')[0];
            currentDate = today >= planData.startDate && today <= planData.endDate
              ? today
              : planData.startDate;

            // 切换到计划执行界面
            initialScreen.classList.add('hidden');
            planExecutionScreen.classList.remove('hidden');
            switchToExecutionScreen();

            showNotification(`已加载计划: ${planData.planName}`, 'success');
          } catch (error) {
            showNotification('加载计划失败: ' + error.message, 'danger');
            console.error('Error loading plan:', error);
          }
        };

        reader.readAsText(file);

        // 重置文件输入，以便可以再次选择同一个文件
        document.getElementById('fileInput').value = '';
      }

      // 更新当天进度
      function updateDayProgress() {
        const dayProgressText = document.getElementById('dayProgressText');
        if (!dayProgressText) return;

        // 如果当天是休息日，不显示进度
        if (currentPlan.days[currentDate]?.skipped) {
          dayProgressText.textContent = '今天是休息日';
          return;
        }

        // 获取当天任务
        const tasks = currentPlan.days[currentDate]?.tasks || currentPlan.baseTasks;
        if (tasks.length === 0) {
          dayProgressText.textContent = '无任务';
          return;
        }

        // 计算已完成任务数
        const completedTasks = tasks.filter(task => task.completed).length;
        const progressPercent = Math.round((completedTasks / tasks.length) * 100);

        dayProgressText.textContent =
          `今日进度: ${completedTasks}/${tasks.length} (${progressPercent}%)`;
      }

      // 更新整体进度
      function updateProgress() {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        if (!progressBar || !progressText) return;

        // 计算总天数
        const start = new Date(currentPlan.startDate);
        const end = new Date(currentPlan.endDate);
        const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

        // 计算已完成天数
        let completedDays = 0;

        // 遍历每一天
        for (let i = 0; i < totalDays; i++) {
          const dateObj = new Date(start);
          dateObj.setDate(start.getDate() + i);
          const dateStr = dateObj.toISOString().split('T')[0];

          // 如果是过去的日期
          if (dateStr < new Date().toISOString().split('T')[0]) {
            const dayData = currentPlan.days[dateStr];

            // 如果是休息日，也算完成
            if (dayData?.skipped) {
              completedDays++;
            }
            // 如果不是休息日，检查任务是否全部完成
            else if (dayData?.tasks) {
              const allCompleted = dayData.tasks.every(task => task.completed);
              if (allCompleted) {
                completedDays++;
              }
            }
            // 如果没有记录，使用基础任务检查
            else {
              const allCompleted = currentPlan.baseTasks.every(task => task.completed);
              if (allCompleted) {
                completedDays++;
              }
            }
          }
        }

        // 计算进度百分比
        const progressPercent = Math.round((completedDays / totalDays) * 100);

        // 更新进度条和文本
        progressBar.style.width = `${progressPercent}%`;
        progressText.textContent =
          `${completedDays}/${totalDays} 天 (${progressPercent}%)`;
      }

      // 计时器功能
      function startTimer() {
        if (isTimerRunning) return;

        isTimerRunning = true;
        document.getElementById('startTimerBtn')?.classList.add('hidden');
        document.getElementById('pauseTimerBtn')?.classList.remove('hidden');

        timerInterval = setInterval(() => {
          timerSeconds++;
          updateTimerDisplay();
        }, 1000);
      }

      function pauseTimer() {
        if (!isTimerRunning) return;

        isTimerRunning = false;
        clearInterval(timerInterval);
        document.getElementById('pauseTimerBtn')?.classList.add('hidden');
        document.getElementById('startTimerBtn')?.classList.remove('hidden');
      }

      function resetTimer() {
        pauseTimer();
        timerSeconds = 0;
        updateTimerDisplay();
      }

      function setTimer(seconds) {
        pauseTimer();
        timerSeconds = seconds;
        updateTimerDisplay();
      }

      function updateTimerDisplay() {
        const timerDisplay = document.getElementById('timerDisplay');
        if (!timerDisplay) return;

        const hours = Math.floor(timerSeconds / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2, '0');
        const seconds = (timerSeconds % 60).toString().padStart(2, '0');

        timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
      }

      // 显示通知
      function showNotification(message, type = 'info') {
        if (!notification || !notificationText || !notificationIcon) return;

        const iconMap = {
          success: 'fa-check-circle',
          warning: 'fa-exclamation-triangle',
          danger: 'fa-times-circle',
          info: 'fa-info-circle'
        };

        const colorMap = {
          success: 'text-success',
          warning: 'text-warning',
          danger: 'text-danger',
          info: 'text-primary'
        };

        notificationText.textContent = message;
        notificationIcon.className = `fa ${iconMap[type]} ${colorMap[type]}`;

        // 显示通知
        notification.classList.remove('translate-y-20', 'opacity-0');
        notification.classList.add('translate-y-0', 'opacity-100');

        // 3秒后隐藏通知
        setTimeout(() => {
          notification.classList.remove('translate-y-0', 'opacity-100');
          notification.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
      }

      // 启动初始化
      init();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>计划管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#f59e0b',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            }
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .card-hover {
                @apply hover:shadow-lg hover:-translate-y-1 transition-all duration-300;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-slate-100 min-h-screen font-sans text-dark">
    <!-- 加载页面 -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-20 h-20 border-4 border-primary border-t-transparent rounded-full animate-spin mb-6"></div>
        <h1 class="text-2xl font-bold text-primary">计划管理系统</h1>
        <p class="text-slate-500 mt-2">正在加载中...</p>
    </div>

    <!-- 初始选择页面 -->
    <div id="initial-screen" class="container mx-auto px-4 py-16 hidden">
        <div class="max-w-2xl mx-auto">
            <div class="text-center mb-12">
                <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-dark mb-4">计划管理系统</h1>
                <p class="text-slate-600 text-lg">高效管理您的日常计划和任务</p>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
                <div class="bg-white rounded-xl shadow-soft p-8 card-hover border border-slate-100">
                    <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                        <i class="fa fa-file-text-o text-primary text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-3">加载已有计划</h3>
                    <p class="text-slate-600 mb-6">读取并继续编辑您之前保存的.yplan格式计划文件</p>
                    <label for="file-upload" class="block w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg text-center cursor-pointer transition-custom">
                        <i class="fa fa-upload mr-2"></i>选择计划文件
                    </label>
                    <input type="file" id="file-upload" accept=".yplan" class="hidden">
                </div>

                <div class="bg-white rounded-xl shadow-soft p-8 card-hover border border-slate-100">
                    <div class="w-16 h-16 bg-secondary/10 rounded-full flex items-center justify-center mb-6">
                        <i class="fa fa-plus text-secondary text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-3">创建新计划</h3>
                    <p class="text-slate-600 mb-6">开始制定新的计划，设置时间、任务和个人信息</p>
                    <button id="create-plan-btn" class="w-full bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-6 rounded-lg transition-custom">
                        <i class="fa fa-pencil mr-2"></i>创建新计划
                    </button>
                </div>
            </div>

            <div class="mt-12 text-center">
                <p class="text-slate-500">最近打开的计划</p>
                <div id="recent-plans" class="mt-4 flex flex-wrap justify-center gap-3">
                    <!-- 最近计划将在这里动态显示 -->
                    <p class="text-slate-400 italic">暂无最近计划</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建计划表单 -->
    <div id="create-plan-form" class="container mx-auto px-4 py-12 hidden">
        <div class="max-w-3xl mx-auto">
            <div class="flex items-center mb-8">
                <button id="back-to-initial" class="text-slate-600 hover:text-primary transition-custom">
                    <i class="fa fa-arrow-left mr-2"></i>返回
                </button>
                <h1 class="text-2xl md:text-3xl font-bold ml-4">创建新计划</h1>
            </div>

            <div class="bg-white rounded-xl shadow-soft p-6 md:p-8 border border-slate-100">
                <form id="plan-form">
                    <div class="grid gap-6 md:grid-cols-2">
                        <div>
                            <label for="username" class="block text-sm font-medium text-slate-700 mb-1">用户名</label>
                            <input type="text" id="username" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="请输入您的姓名">
                        </div>

                        <div>
                            <label for="plan-title" class="block text-sm font-medium text-slate-700 mb-1">计划标题</label>
                            <input type="text" id="plan-title" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="给您的计划起个名字">
                        </div>

                        <div>
                            <label for="start-date" class="block text-sm font-medium text-slate-700 mb-1">开始日期</label>
                            <input type="date" id="start-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom">
                        </div>

                        <div>
                            <label for="end-date" class="block text-sm font-medium text-slate-700 mb-1">结束日期</label>
                            <input type="date" id="end-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom">
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-medium text-slate-700 mb-3">每日任务设置</label>

                        <div id="tasks-container">
                            <div class="task-item flex items-center gap-3 mb-3 p-3 bg-slate-50 rounded-lg">
                                <input type="text" class="task-input flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="输入任务内容">
                                <button type="button" class="remove-task text-slate-400 hover:text-red-500 transition-custom">
                                    <i class="fa fa-trash-o"></i>
                                </button>
                            </div>
                        </div>

                        <button type="button" id="add-task" class="mt-3 text-primary hover:text-primary/80 font-medium flex items-center transition-custom">
                            <i class="fa fa-plus-circle mr-2"></i>添加任务
                        </button>
                    </div>

                    <div class="mt-6">
                        <label for="plan-notes" class="block text-sm font-medium text-slate-700 mb-1">备注信息（可选）</label>
                        <textarea id="plan-notes" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="添加一些额外的备注信息..."></textarea>
                    </div>

                    <div class="mt-8 flex justify-end gap-4">
                        <button type="button" id="cancel-create" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-custom">
                            取消
                        </button>
                        <button type="submit" class="px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-custom">
                            开始计划
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 计划管理界面 -->
    <div id="plan-management" class="container mx-auto px-4 py-8 hidden">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <button id="back-from-management" class="text-slate-600 hover:text-primary transition-custom mb-2 md:mb-0">
                        <i class="fa fa-arrow-left mr-2"></i>返回
                    </button>
                    <h1 id="management-plan-title" class="text-2xl md:text-3xl font-bold">我的计划</h1>
                    <p id="management-plan-dates" class="text-slate-600">2023年6月1日 - 2023年6月30日</p>
                </div>

                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <p class="text-sm text-slate-500">当前用户</p>
                        <p id="management-username" class="font-medium">用户名</p>
                    </div>
                    <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center text-primary">
                        <i class="fa fa-user"></i>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid gap-6 md:grid-cols-3">
            <!-- 左侧：统计信息 -->
            <div class="md:col-span-1">
                <div class="bg-white rounded-xl shadow-soft p-6 border border-slate-100 mb-6">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-bar-chart text-accent mr-2"></i>计划进度
                    </h2>

                    <div class="mb-6">
                        <div class="flex justify-between text-sm mb-1">
                            <span>完成率</span>
                            <span id="completion-rate">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div id="completion-bar" class="bg-secondary h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-primary rounded-full mr-2"></div>
                                <span>总天数</span>
                            </div>
                            <span id="total-days">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-secondary rounded-full mr-2"></div>
                                <span>已完成</span>
                            </div>
                            <span id="completed-days">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-slate-300 rounded-full mr-2"></div>
                                <span>未完成</span>
                            </div>
                            <span id="remaining-days">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-accent rounded-full mr-2"></div>
                                <span>今日任务</span>
                            </div>
                            <span id="today-tasks">0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-soft p-6 border border-slate-100">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-sticky-note-o text-primary mr-2"></i>备注信息
                    </h2>
                    <p id="management-notes" class="text-slate-600 text-sm italic">无备注信息</p>
                </div>
            </div>

            <!-- 右侧：任务管理 -->
            <div class="md:col-span-2">
                <div class="bg-white rounded-xl shadow-soft p-6 border border-slate-100 mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-calendar text-primary mr-2"></i>
                            <span id="current-date-display">2023年6月1日</span>
                        </h2>
                        <div class="flex gap-2">
                            <button id="prev-day" class="p-2 rounded-full hover:bg-slate-100 transition-custom">
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <button id="next-day" class="p-2 rounded-full hover:bg-slate-100 transition-custom">
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div id="daily-tasks-container" class="space-y-3">
                        <!-- 每日任务将在这里动态显示 -->
                    </div>

                    <div class="mt-6 flex justify-between items-center">
                        <span id="day-completion-status" class="text-sm text-slate-500">0/0 任务完成</span>
                        <button id="save-day-progress" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm transition-custom">
                            <i class="fa fa-save mr-1"></i>保存今日进度
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-soft p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-calendar-check-o text-secondary mr-2"></i>计划日历
                        </h2>
                        <button id="save-plan" class="px-4 py-2 bg-secondary hover:bg-secondary/90 text-white rounded-lg text-sm transition-custom">
                            <i class="fa fa-download mr-1"></i>保存完整计划
                        </button>
                    </div>

                    <div id="plan-calendar" class="grid grid-cols-7 gap-1 text-center">
                        <!-- 星期标题 -->
                        <div class="text-xs font-medium text-slate-500 py-2">日</div>
                        <div class="text-xs font-medium text-slate-500 py-2">一</div>
                        <div class="text-xs font-medium text-slate-500 py-2">二</div>
                        <div class="text-xs font-medium text-slate-500 py-2">三</div>
                        <div class="text-xs font-medium text-slate-500 py-2">四</div>
                        <div class="text-xs font-medium text-slate-500 py-2">五</div>
                        <div class="text-xs font-medium text-slate-500 py-2">六</div>

                        <!-- 日历格子将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-6 right-6 bg-dark text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-40">
        <i id="notification-icon" class="fa fa-check-circle mr-2"></i>
        <span id="notification-message">操作成功</span>
    </div>

    <script>
        // 全局变量
        let currentPlan = null;
        let currentDate = new Date();
        let recentPlans = JSON.parse(localStorage.getItem('recentPlans') || '[]');

        // DOM 元素加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            // 模拟加载过程
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('initial-screen').classList.remove('hidden');
                renderRecentPlans();
            }, 1500);

            // 事件监听
            setupEventListeners();
        });

        // 设置所有事件监听
        function setupEventListeners() {
            // 初始页面事件
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            document.getElementById('create-plan-btn').addEventListener('click', () => {
                document.getElementById('initial-screen').classList.add('hidden');
                document.getElementById('create-plan-form').classList.remove('hidden');
                // 设置默认日期
                const today = new Date();
                document.getElementById('start-date').valueAsDate = today;
                // 默认结束日期为7天后
                const endDate = new Date();
                endDate.setDate(today.getDate() + 7);
                document.getElementById('end-date').valueAsDate = endDate;
            });

            // 创建计划表单事件
            document.getElementById('back-to-initial').addEventListener('click', () => {
                document.getElementById('create-plan-form').classList.add('hidden');
                document.getElementById('initial-screen').classList.remove('hidden');
            });

            document.getElementById('cancel-create').addEventListener('click', () => {
                document.getElementById('create-plan-form').classList.add('hidden');
                document.getElementById('initial-screen').classList.remove('hidden');
            });

            document.getElementById('add-task').addEventListener('click', addTaskField);

            document.getElementById('plan-form').addEventListener('submit', (e) => {
                e.preventDefault();
                createNewPlan();
            });

            // 计划管理界面事件
            document.getElementById('back-from-management').addEventListener('click', () => {
                document.getElementById('plan-management').classList.add('hidden');
                document.getElementById('initial-screen').classList.remove('hidden');
            });

            document.getElementById('prev-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                if (isDateWithinPlanRange(currentDate)) {
                    renderDailyTasks();
                } else {
                    currentDate.setDate(currentDate.getDate() + 1);
                    showNotification('已经是计划的第一天了', 'info');
                }
            });

            document.getElementById('next-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                if (isDateWithinPlanRange(currentDate)) {
                    renderDailyTasks();
                } else {
                    currentDate.setDate(currentDate.getDate() - 1);
                    showNotification('已经是计划的最后一天了', 'info');
                }
            });

            document.getElementById('save-day-progress').addEventListener('click', saveDayProgress);
            document.getElementById('save-plan').addEventListener('click', exportPlan);
        }

        // 处理文件上传
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.name.endsWith('.yplan')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const planData = JSON.parse(e.target.result);
                        loadPlan(planData);
                        addToRecentPlans(file.name, planData);
                        showNotification('计划加载成功', 'success');
                    } catch (error) {
                        showNotification('文件格式错误，无法加载计划', 'error');
                        console.error('Error parsing plan file:', error);
                    }
                };
                reader.readAsText(file);
            } else {
                showNotification('请选择.yplan格式的文件', 'error');
            }

            // 重置文件输入，允许重复选择同一个文件
            event.target.value = '';
        }

        // 添加任务输入框
        function addTaskField() {
            const container = document.getElementById('tasks-container');
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item flex items-center gap-3 mb-3 p-3 bg-slate-50 rounded-lg';
            taskItem.innerHTML = `
                <input type="text" class="task-input flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="输入任务内容">
                <button type="button" class="remove-task text-slate-400 hover:text-red-500 transition-custom">
                    <i class="fa fa-trash-o"></i>
                </button>
            `;
            container.appendChild(taskItem);

            // 添加删除任务事件
            taskItem.querySelector('.remove-task').addEventListener('click', () => {
                container.removeChild(taskItem);
            });
        }

        // 创建新计划
        function createNewPlan() {
            const username = document.getElementById('username').value.trim();
            const title = document.getElementById('plan-title').value.trim();
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const notes = document.getElementById('plan-notes').value.trim();

            // 验证输入
            if (!username) {
                showNotification('请输入用户名', 'error');
                return;
            }

            if (!title) {
                showNotification('请输入计划标题', 'error');
                return;
            }

            if (!startDate || !endDate) {
                showNotification('请选择计划的开始和结束日期', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showNotification('开始日期不能晚于结束日期', 'error');
                return;
            }

            // 收集任务
            const taskInputs = document.querySelectorAll('.task-input');
            const tasks = Array.from(taskInputs)
                .map(input => input.value.trim())
                .filter(task => task);

            if (tasks.length === 0) {
                showNotification('请至少添加一个任务', 'error');
                return;
            }

            // 创建计划对象
            const plan = {
                id: Date.now(),
                title,
                username,
                startDate,
                endDate,
                notes,
                tasks,
                progress: {} // 用于存储每日进度，格式: "YYYY-MM-DD": { completed: [true/false, ...], isComplete: false }
            };

            // 初始化进度数据
            const start = new Date(startDate);
            const end = new Date(endDate);
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                plan.progress[dateStr] = {
                    completed: tasks.map(() => false),
                    isComplete: false
                };
            }

            // 保存计划并切换到管理界面
            currentPlan = plan;
            currentDate = new Date(startDate);

            document.getElementById('create-plan-form').classList.add('hidden');
            document.getElementById('plan-management').classList.remove('hidden');

            // 重置表单
            document.getElementById('plan-form').reset();
            document.getElementById('tasks-container').innerHTML = `
                <div class="task-item flex items-center gap-3 mb-3 p-3 bg-slate-50 rounded-lg">
                    <input type="text" class="task-input flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="输入任务内容">
                    <button type="button" class="remove-task text-slate-400 hover:text-red-500 transition-custom">
                        <i class="fa fa-trash-o"></i>
                    </button>
                </div>
            `;

            // 渲染计划管理界面
            renderPlanManagement();

            // 添加到最近计划
            const fileName = `${title}_${formatDateForFileName(new Date())}.yplan`;
            addToRecentPlans(fileName, plan);

            showNotification('计划创建成功', 'success');
        }

        // 加载计划
        function loadPlan(planData) {
            currentPlan = planData;
            currentDate = new Date(planData.startDate);

            document.getElementById('initial-screen').classList.add('hidden');
            document.getElementById('plan-management').classList.remove('hidden');

            renderPlanManagement();
        }

        // 渲染计划管理界面
        function renderPlanManagement() {
            if (!currentPlan) return;

            // 更新标题和日期
            document.getElementById('management-plan-title').textContent = currentPlan.title;
            document.getElementById('management-username').textContent = currentPlan.username;

            const start = new Date(currentPlan.startDate);
            const end = new Date(currentPlan.endDate);
            document.getElementById('management-plan-dates').textContent =
                `${start.getFullYear()}年${start.getMonth() + 1}月${start.getDate()}日 - ${end.getFullYear()}年${end.getMonth() + 1}月${end.getDate()}日`;

            // 更新备注
            document.getElementById('management-notes').textContent = currentPlan.notes || '无备注信息';

            // 渲染每日任务
            renderDailyTasks();

            // 渲染日历
            renderCalendar();

            // 更新统计信息
            updateStatistics();
        }

        // 渲染每日任务
        function renderDailyTasks() {
            if (!currentPlan) return;

            const dateStr = formatDate(currentDate);
            document.getElementById('current-date-display').textContent =
                `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月${currentDate.getDate()}日`;

            const container = document.getElementById('daily-tasks-container');
            container.innerHTML = '';

            // 获取当天进度
            const dayProgress = currentPlan.progress[dateStr];

            // 创建任务列表
            currentPlan.tasks.forEach((task, index) => {
                const taskElement = document.createElement('div');
                taskElement.className = 'flex items-center p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition-custom';
                taskElement.innerHTML = `
                    <input type="checkbox" class="task-checkbox w-5 h-5 rounded text-primary focus:ring-primary" ${dayProgress.completed[index] ? 'checked' : ''}>
                    <span class="ml-3 flex-1 ${dayProgress.completed[index] ? 'line-through text-slate-400' : ''}">${task}</span>
                `;
                container.appendChild(taskElement);

                // 添加复选框事件
                taskElement.querySelector('.task-checkbox').addEventListener('change', (e) => {
                    const span = taskElement.querySelector('span');
                    if (e.target.checked) {
                        span.classList.add('line-through', 'text-slate-400');
                    } else {
                        span.classList.remove('line-through', 'text-slate-400');
                    }

                    // 更新完成状态显示
                    updateDayCompletionStatus();
                });
            });

            // 更新完成状态显示
            updateDayCompletionStatus();
        }

        // 更新当日完成状态
        function updateDayCompletionStatus() {
            const checkboxes = document.querySelectorAll('.task-checkbox');
            const total = checkboxes.length;
            const completed = Array.from(checkboxes).filter(cb => cb.checked).length;

            document.getElementById('day-completion-status').textContent = `${completed}/${total} 任务完成`;
        }

        // 保存当日进度
        function saveDayProgress() {
            if (!currentPlan) return;

            const dateStr = formatDate(currentDate);
            const checkboxes = document.querySelectorAll('.task-checkbox');

            // 更新进度数据
            currentPlan.progress[dateStr].completed = Array.from(checkboxes).map(cb => cb.checked);
            currentPlan.progress[dateStr].isComplete = Array.from(checkboxes).every(cb => cb.checked);

            // 更新统计信息
            updateStatistics();

            // 更新日历
            renderCalendar();

            showNotification('今日进度已保存', 'success');
        }

        // 渲染日历
        function renderCalendar() {
            if (!currentPlan) return;

            const calendarContainer = document.getElementById('plan-calendar');
            // 保留星期标题，清空其他内容
            while (calendarContainer.children.length > 7) {
                calendarContainer.removeChild(calendarContainer.lastChild);
            }

            const start = new Date(currentPlan.startDate);
            const end = new Date(currentPlan.endDate);

            // 计算需要多少个空单元格来对齐第一周
            const firstDayOfMonth = new Date(start.getFullYear(), start.getMonth(), 1);
            const startDayOfWeek = start.getDay(); // 0-6, 0是星期日

            // 添加空白单元格
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'h-10 flex items-center justify-center text-sm text-slate-300';
                calendarContainer.appendChild(emptyCell);
            }

            // 添加日期单元格
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const dayProgress = currentPlan.progress[dateStr];
                const isToday = formatDate(d) === formatDate(new Date());
                const isCurrent = formatDate(d) === formatDate(currentDate);

                const dayCell = document.createElement('div');
                dayCell.className = `h-10 flex items-center justify-center text-sm rounded-full cursor-pointer transition-custom relative
                                    ${isToday ? 'bg-primary/10 text-primary font-medium' : ''}
                                    ${isCurrent ? 'ring-2 ring-primary' : ''}
                                    ${dayProgress.isComplete ? 'hover:bg-secondary/20' : 'hover:bg-slate-100'}`;

                dayCell.innerHTML = `<span>${d.getDate()}</span>`;

                // 添加完成标记
                if (dayProgress.isComplete) {
                    dayCell.innerHTML += `<i class="fa fa-check absolute bottom-1 text-secondary text-xs"></i>`;
                }

                // 添加点击事件
                dayCell.addEventListener('click', () => {
                    currentDate = new Date(d);
                    renderDailyTasks();
                });

                calendarContainer.appendChild(dayCell);
            }
        }

        // 更新统计信息
        function updateStatistics() {
            if (!currentPlan) return;

            const start = new Date(currentPlan.startDate);
            const end = new Date(currentPlan.endDate);
            const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            let completedDays = 0;
            Object.values(currentPlan.progress).forEach(progress => {
                if (progress.isComplete) completedDays++;
            });

            const remainingDays = totalDays - completedDays;
            const completionRate = Math.round((completedDays / totalDays) * 100);

            // 更新统计显示
            document.getElementById('total-days').textContent = totalDays;
            document.getElementById('completed-days').textContent = completedDays;
            document.getElementById('remaining-days').textContent = remainingDays;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('completion-bar').style.width = `${completionRate}%`;
            document.getElementById('today-tasks').textContent = currentPlan.tasks.length;
        }

        // 导出计划
        function exportPlan() {
            if (!currentPlan) return;

            const planData = JSON.stringify(currentPlan);
            const blob = new Blob([planData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            const fileName = `${currentPlan.title}_${formatDateForFileName(new Date())}.yplan`;
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);

            // 添加到最近计划
            addToRecentPlans(fileName, currentPlan);

            showNotification('计划已保存', 'success');
        }

        // 渲染最近计划
        function renderRecentPlans() {
            const container = document.getElementById('recent-plans');

            if (recentPlans.length === 0) {
                container.innerHTML = '<p class="text-slate-400 italic">暂无最近计划</p>';
                return;
            }

            container.innerHTML = '';

            // 只显示最近的5个计划
            const recentToShow = recentPlans.slice(0, 5);

            recentToShow.forEach(item => {
                const planElement = document.createElement('div');
                planElement.className = 'bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm flex items-center gap-2 hover:border-primary cursor-pointer transition-custom';
                planElement.innerHTML = `
                    <i class="fa fa-file-text-o text-primary"></i>
                    <span class="truncate max-w-[150px]">${item.name}</span>
                `;

                planElement.addEventListener('click', () => {
                    loadPlan(item.data);
                });

                container.appendChild(planElement);
            });
        }

        // 添加到最近计划
        function addToRecentPlans(fileName, planData) {
            // 移除已存在的相同计划
            recentPlans = recentPlans.filter(item => item.id !== planData.id);

            // 添加新计划到开头
            recentPlans.unshift({
                id: planData.id,
                name: fileName,
                data: planData,
                lastAccessed: new Date().toISOString()
            });

            // 保存到本地存储
            localStorage.setItem('recentPlans', JSON.stringify(recentPlans));

            // 更新显示
            renderRecentPlans();
        }

        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notification-icon');
            const messageElement = document.getElementById('notification-message');

            // 设置图标和样式
            if (type === 'success') {
                icon.className = 'fa fa-check-circle mr-2 text-green-400';
                notification.classList.remove('bg-red-600', 'bg-blue-600');
                notification.classList.add('bg-green-600');
            } else if (type === 'error') {
                icon.className = 'fa fa-exclamation-circle mr-2 text-red-300';
                notification.classList.remove('bg-green-600', 'bg-blue-600');
                notification.classList.add('bg-red-600');
            } else if (type === 'info') {
                icon.className = 'fa fa-info-circle mr-2 text-blue-300';
                notification.classList.remove('bg-green-600', 'bg-red-600');
                notification.classList.add('bg-blue-600');
            }

            // 设置消息
            messageElement.textContent = message;

            // 显示通知
            notification.classList.remove('translate-y-20', 'opacity-0');
            notification.classList.add('translate-y-0', 'opacity-100');

            // 3秒后隐藏
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // 辅助函数：格式化日期为YYYY-MM-DD
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // 辅助函数：格式化日期用于文件名
        function formatDateForFileName(date) {
            return `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        }

        // 辅助函数：检查日期是否在计划范围内
        function isDateWithinPlanRange(date) {
            if (!currentPlan) return false;

            const dateStr = formatDate(date);
            return currentPlan.progress.hasOwnProperty(dateStr);
        }
    </script>
</body>
</html>
